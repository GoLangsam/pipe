// This file was automatically generated by genny.
// Any changes will be lost if this file is regenerated.
// see https://github.com/cheekybits/genny

// Copyright 2017 Andreas Pannewitz. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file.

package pipe

// ===========================================================================
// Beg of PipeThingEnter/Leave - Flapdoors observed by a Waiter

// ThingWaiter - as implemented by `*sync.WaitGroup` -
// attends Flapdoors and keeps track of
// how many enter and how many leave.
//
// Use Your provided `*sync.WaitGroup.Wait()`
// to know when to close the facilities.
//
// Just make sure to have _all_ entrances and exits attended,
// and don't `wg.Wait()` before You've flooded the facilities.
type ThingWaiter interface {
	Add(delta int)
	Done()
	// Wait() // here no need
}

// Note: Name is generic in order to avoid multiple-declaration clashes.

// PipeThingEnter returns a channel to receive
// all `inp`
// and registers throughput
// as arrival
// on the given `sync.WaitGroup`
// until close.
func PipeThingEnter(inp <-chan Thing, wg ThingWaiter) (out <-chan Thing) {
	cha := make(chan Thing)
	go pipeThingEnter(cha, wg, inp)
	return cha
}

// PipeThingLeave returns a channel to receive
// all `inp`
// and registers throughput
// as departure
// on the given `sync.WaitGroup`
// until close.
func PipeThingLeave(inp <-chan Thing, wg ThingWaiter) (out <-chan Thing) {
	cha := make(chan Thing)
	go pipeThingLeave(cha, wg, inp)
	return cha
}

func pipeThingEnter(out chan<- Thing, wg ThingWaiter, inp <-chan Thing) {
	defer close(out)
	for i := range inp {
		wg.Add(1)
		out <- i
	}
}

func pipeThingLeave(out chan<- Thing, wg ThingWaiter, inp <-chan Thing) {
	defer close(out)
	for i := range inp {
		out <- i
		wg.Done()
	}
}

// TubeThingEnter returns a closure around PipeThingEnter (_, wg)
// registering throughput
// on the given `sync.WaitGroup`
// as arrival.
func TubeThingEnter(wg ThingWaiter) (tube func(inp <-chan Thing) (out <-chan Thing)) {

	return func(inp <-chan Thing) (out <-chan Thing) {
		return PipeThingEnter(inp, wg)
	}
}

// TubeThingLeave returns a closure around PipeThingLeave (_, wg)
// registering throughput
// on the given `sync.WaitGroup`
// as departure.
func TubeThingLeave(wg ThingWaiter) (tube func(inp <-chan Thing) (out <-chan Thing)) {

	return func(inp <-chan Thing) (out <-chan Thing) {
		return PipeThingLeave(inp, wg)
	}
}

// End of PipeThingEnter/Leave - Flapdoors observed by a Waiter
